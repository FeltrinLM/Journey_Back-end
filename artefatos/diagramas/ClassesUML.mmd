classDiagram

%%Models
    class Colecao {
        - int colecaoId
        - String nome
        - LocalDate dataInicio
        - LocalDate dataFim
        +getColecaoId(): int
        +setColecaoId(int): void
        +getNome(): String
        +setNome(String): void
        +getDataInicio(): LocalDate
        +setDataInicio(LocalDate): void
        +getDataFim(): LocalDate
        +setDataFim(LocalDate): void
        +getEstampas(): List<Estampa>
        +getChaveiros(): List<Chaveiro>
    }

    class Estampa {
        - int estampaId
        - String nome
        - int quantidade
        - Colecao colecao
        +getEstampaId(): int
        +setEstampaId(int): void
        +getNome(): String
        +setNome(String): void
        +getQuantidade(): int
        +setQuantidade(int): void
        +getColecao(): Colecao
        +setColecao(Colecao): void
    }

    class Peca {
        - int pecaId
        - String tipo
        - String tamanho
        - String cor
        - int quantidade
        +getPecaId(): int
        +setPecaId(int): void
        +getTipo(): String
        +setTipo(String): void
        +getTamanho(): String
        +setTamanho(String): void
        +getCor(): String
        +setCor(String): void
        +getQuantidade(): int
        +setQuantidade(int): void
    }


    class Chaveiro {
        - int chaveiroId
        - String chaveiroModelo
        - Colecao colecao
        +getChaveiroId(): int
        +setChaveiroId(int): void
        +getChaveiroModelo(): String
        +setChaveiroModelo(String): void
        +getColecao(): Colecao
        +setColecao(Colecao): void
    }

    class Adesivo {
        - int adesivoId
        - String adesivoModelo
        - boolean cromatico
        +getAdesivoId(): int
        +setAdesivoId(int): void
        +getAdesivoModelo(): String
        +setAdesivoModelo(String): void
        +isCromatico(): boolean
        +setCromatico(boolean): void
    }

    class Usuario {
        - int usuarioId
        - String nome
        - String senha
        - TipoUsuario tipo
        - List<HistoricoAlteracao> historicos
        + Usuario()
        + Usuario(String nome, String senha, TipoUsuario tipo)
        + getUsuarioId(): int
        + setUsuarioId(int): void
        + getNome(): String
        + setNome(String): void
        + getSenha(): String
        + setSenha(String): void
        + getTipo(): TipoUsuario
        + setTipo(TipoUsuario): void
        + getHistoricos(): List<HistoricoAlteracao>
        + setHistoricos(List<HistoricoAlteracao>): void
    }

    class TipoUsuario {
        <<enumeration>>
        ADMINISTRADOR
        FUNCIONARIO
    }

    class HistoricoAlteracao {
        - Long id
        - String entidade
        - int entidadeId
        - String campoAlterado
        - String valorAntigo
        - String valorNovo
        - LocalDateTime dataHora
        - Usuario usuario
        + getId(): Long
        + setId(Long): void
        + getEntidade(): String
        + setEntidade(String): void
        + getEntidadeId(): int
        + setEntidadeId(int): void
        + getCampoAlterado(): String
        + setCampoAlterado(String): void
        + getValorAntigo(): String
        + setValorAntigo(String): void
        + getValorNovo(): String
        + setValorNovo(String): void
        + getDataHora(): LocalDateTime
        + setDataHora(LocalDateTime): void
        + getUsuario(): Usuario
        + setUsuario(Usuario): void
    }

    Colecao "1" --> "n" Estampa : contem
    Colecao "1" --> "n" Chaveiro : contem
    Usuario --> TipoUsuario : tipo
    Usuario "1" --> "n" HistoricoAlteracao : realiza
    HistoricoAlteracao "n" ..> "1" Peca : registra alterações em
    HistoricoAlteracao "n" ..> "1" Colecao : registra alterações em
    HistoricoAlteracao "n" ..> "1" Estampa : registra alterações em
    HistoricoAlteracao "n" ..> "1" Adesivo : registra alterações em
    HistoricoAlteracao "n" ..> "1" Chaveiro : registra alterações em

%% Repositories

    class ColecaoRepository {
        <<interface>>
        +Optional<Colecao> findByNome(String nome)
        +Optional<Colecao> findById(int id)
        +List<Colecao> findAll()
        +Colecao save(Colecao colecao)
        +void deleteById(int id)
    }

    class EstampaRepository {
        <<interface>>
        +Optional<Estampa> findById(int id)
        +List<Estampa> findByNome(String nome)
        +List<Estampa> findAll()
        +Estampa save(Estampa estampa)
        +void deleteById(int id)
    }

    class PecaRepository {
        <<interface>>
        +Optional<Peca> findById(int id)
        +List<Peca> findByTipo(String tipo)
        +List<Peca> findByTamanho(String tamanho)
        +List<Peca> findByCor(String cor)
        +List<Peca> findByTipoAndTamanhoAndCor(String tipo, String tamanho, String cor)
        +List<Peca> findAll()
        +Peca save(Peca peca)
        +void deleteById(int id)
    }

    class ChaveiroRepository {
        <<interface>>
        +Optional<Chaveiro> findById(int id)
        +Optional<Chaveiro> findByChaveiroModelo(String chaveiroModelo)
        +List<Chaveiro> findByColecao(Colecao colecao)
        +Optional<Chaveiro> findByChaveiroModeloAndColecao(String chaveiroModelo, Colecao colecao)
        +List<Chaveiro> findAll()
        +Chaveiro save(Chaveiro chaveiro)
        +void deleteById(int id)
    }

    class AdesivoRepository {
        <<interface>>
        +List<Adesivo> findAll()
        +Optional<Adesivo> findById(int id)
        +Adesivo save(Adesivo adesivo)
        +void deleteById(int id)
    }

    class UsuarioRepository {
        <<interface>>
        +Optional<Usuario> findByNome(String nome)
        +boolean existsByNome(String nome)
        +Optional<Usuario> findById(int id)
        +List<Usuario> findAll()
        +Usuario save(Usuario usuario)
        +void deleteById(int id)
    }

    class HistoricoAlteracaoRepository {
        <<interface>>
        +List<HistoricoAlteracao> findByEntidade(String entidade)
        +List<HistoricoAlteracao> findByEntidadeAndEntidadeId(String entidade, int entidadeId)
        +List<HistoricoAlteracao> findByUsuarioUsuarioId(int usuarioId)
        +List<HistoricoAlteracao> findAllByOrderByDataHoraDesc()
        +boolean existsByUsuarioUsuarioId(int usuarioId)
        +Optional<HistoricoAlteracao> findById(Long id)
        +List<HistoricoAlteracao> findAll()
        +HistoricoAlteracao save(HistoricoAlteracao historico)
        +void deleteById(Long id)
    }

%% Services

    class ColecaoService {
        - ColecaoRepository colecaoRepository
        - HistoricoAlteracaoService historicoService
        + listarColecoes(): List<ColecaoDTO>
        + buscarPorId(int id): ColecaoDTO
        + criarColecao(ColecaoDTO dto, Usuario autor): ColecaoDTO
        + editarColecao(int id, ColecaoDTO dto, Usuario autor): ColecaoDTO
        + deletarColecao(int id, Usuario autor): void
        - registrarLog(Integer autorId, String entidade, int entidadeId, String campo, String valorAntigo, String valorNovo): void
    }

    class EstampaService {
        - EstampaRepository estampaRepository
        - ColecaoRepository colecaoRepository
        - HistoricoAlteracaoService historicoService
        + listarEstampas(): List<EstampaDTO>
        + buscarPorId(int id): EstampaDTO
        + criarEstampa(EstampaDTO dto, Usuario autor): EstampaDTO
        + editarEstampa(int id, EstampaDTO dto, Usuario autor): EstampaDTO
        + deletarEstampa(int id, Usuario autor): void
        - registrarLog(Integer autorId, String entidade, int entidadeId, String campo, String valorAntigo, String valorNovo): void
    }

    class PecaService {
        - PecaRepository pecaRepository
        - HistoricoAlteracaoService historicoService
        + listarPecas(): List<PecaDTO>
        + buscarPorId(int id): PecaDTO
        + criarPeca(PecaDTO dto, Usuario autor): PecaDTO
        + editarPeca(int id, PecaDTO dto, Usuario autor): PecaDTO
        + deletarPeca(int id, Usuario autor): void
        - registrarLog(Integer autorId, String entidade, int entidadeId, String campo, String valorAntigo, String valorNovo): void
    }

    class ChaveiroService {
        - ChaveiroRepository chaveiroRepository
        - ColecaoRepository colecaoRepository
        - HistoricoAlteracaoService historicoService
        + listarChaveiros(): List<ChaveiroDTO>
        + buscarPorId(int id): ChaveiroDTO
        + criarChaveiro(ChaveiroDTO dto, Usuario autor): ChaveiroDTO
        + editarChaveiro(int id, ChaveiroDTO dto, Usuario autor): ChaveiroDTO
        + deletarChaveiro(int id, Usuario autor): void
        - registrarLog(Integer autorId, String entidade, int entidadeId, String campo, String valorAntigo, String valorNovo): void
    }

    class AdesivoService {
        - AdesivoRepository adesivoRepository
        - HistoricoAlteracaoService historicoService
        + listarAdesivos(): List<AdesivoDTO>
        + buscarPorId(int id): AdesivoDTO
        + criarAdesivo(AdesivoDTO dto, Usuario autor): AdesivoDTO
        + editarAdesivo(int id, AdesivoDTO dto, Usuario autor): AdesivoDTO
        + deletarAdesivo(int id, Usuario autor): void
        - registrarLog(Integer autorId, String entidade, int entidadeId, String campo, String valorAntigo, String valorNovo): void
    }

    class UsuarioService {
        - UsuarioRepository usuarioRepository
        - HistoricoAlteracaoService historicoService
        - HistoricoAlteracaoRepository historicoRepository
        - PasswordEncoder passwordEncoder
        + listarUsuarios(): List<UsuarioDTO>
        + buscarPorId(int id): UsuarioDTO
        + criarUsuario(UsuarioDTO dto): UsuarioDTO
        + criarUsuario(UsuarioDTO dto, Usuario autor): UsuarioDTO
        + editarUsuario(int id, UsuarioDTO dto): UsuarioDTO
        + editarUsuario(int id, UsuarioDTO dto, Usuario autor): UsuarioDTO
        + deletarUsuario(int id): void
        + deletarUsuario(int id, Usuario autor): void
        + validarLogin(String nome, String senha): boolean
        + sistemaSemUsuarios(): boolean
        + criarAdminPadrao(): UsuarioDTO
        - logAlteracao(Integer autorId, String entidade, int entidadeId, String campoAlterado, String valorAntigo, String valorNovo): void
    }

    class HistoricoAlteracaoService {
        - HistoricoAlteracaoRepository historicoRepository
        - UsuarioRepository usuarioRepository
        + listarAlteracoes(): List<HistoricoAlteracaoDTO>
        + buscarPorId(Long id): HistoricoAlteracaoDTO
        + registrarAlteracao(HistoricoAlteracaoDTO dto): void
    }

%% Mappers

    class ColecaoMapper {
        <<final>>
        + toDTO(Colecao): ColecaoDTO
        + toModel(ColecaoDTO): Colecao
    }

    class EstampaMapper {
        <<final>>
        + toDTO(Estampa): EstampaDTO
        + toModel(EstampaDTO, Colecao): Estampa
    }

    class PecaMapper {
        <<final>>
        + toDTO(Peca): PecaDTO
        + toModel(PecaDTO): Peca
    }

    class ChaveiroMapper {
        <<final>>
        + toDTO(Chaveiro): ChaveiroDTO
        + toModel(ChaveiroDTO, Colecao): Chaveiro
    }

    class AdesivoMapper {
        <<final>>
        + toDTO(Adesivo): AdesivoDTO
        + toModel(AdesivoDTO): Adesivo
    }

    class UsuarioMapper {
        <<final>>
        + toDTO(Usuario): UsuarioDTO
        + toModel(UsuarioDTO): Usuario
        + updateModelFromDTO(UsuarioDTO, Usuario): void
    }

    class HistoricoAlteracaoMapper {
        <<final>>
        + toDTO(HistoricoAlteracao): HistoricoAlteracaoDTO
        + toModel(HistoricoAlteracaoDTO, Usuario): HistoricoAlteracao
    }

%% DTOs

    class ColecaoDTO {
        - int colecaoId
        - String nome
        - LocalDate dataInicio
        - LocalDate dataFim
        + getColecaoId(): int
        + setColecaoId(int): void
        + getNome(): String
        + setNome(String): void
        + getDataInicio(): LocalDate
        + setDataInicio(LocalDate): void
        + getDataFim(): LocalDate
        + setDataFim(LocalDate): void
    }

    class EstampaDTO {
        - int estampaId
        - String nome
        - int quantidade
        - Integer colecaoId
        + getEstampaId(): int
        + setEstampaId(int): void
        + getNome(): String
        + setNome(String): void
        + getQuantidade(): int
        + setQuantidade(int): void
        + getColecaoId(): Integer
        + setColecaoId(Integer): void
    }

    class PecaDTO {
        - int pecaId
        - String tipo
        - String tamanho
        - String cor
        - int quantidade
        + getPecaId(): int
        + setPecaId(int): void
        + getTipo(): String
        + setTipo(String): void
        + getTamanho(): String
        + setTamanho(String): void
        + getCor(): String
        + setCor(String): void
        + getQuantidade(): int
        + setQuantidade(int): void
    }

    class ChaveiroDTO {
        - int chaveiroId
        - String chaveiroModelo
        - Integer colecaoId
        + getChaveiroId(): int
        + setChaveiroId(int): void
        + getChaveiroModelo(): String
        + setChaveiroModelo(String): void
        + getColecaoId(): Integer
        + setColecaoId(Integer): void
    }

    class AdesivoDTO {
        - int adesivoId
        - String adesivoModelo
        - boolean cromatico
        + getAdesivoId(): int
        + setAdesivoId(int): void
        + getAdesivoModelo(): String
        + setAdesivoModelo(String): void
        + isCromatico(): boolean
        + setCromatico(boolean): void
    }

    class UsuarioDTO {
        - int usuarioId
        - String nome
        - String senha
        - String tipo
        + getUsuarioId(): int
        + setUsuarioId(int): void
        + getNome(): String
        + setNome(String): void
        + getSenha(): String
        + setSenha(String): void
        + getTipo(): String
        + setTipo(String): void
    }

    class HistoricoAlteracaoDTO {
        - long id
        - String entidade
        - int entidadeId
        - String campoAlterado
        - String valorAntigo
        - String valorNovo
        - LocalDateTime dataHora
        - Integer usuarioId
        + getId(): long
        + setId(long): void
        + getEntidade(): String
        + setEntidade(String): void
        + getEntidadeId(): int
        + setEntidadeId(int): void
        + getCampoAlterado(): String
        + setCampoAlterado(String): void
        + getValorAntigo(): String
        + setValorAntigo(String): void
        + getValorNovo(): String
        + setValorNovo(String): void
        + getDataHora(): LocalDateTime
        + setDataHora(LocalDateTime): void
        + getUsuarioId(): Integer
        + setUsuarioId(Integer): void
    }

%% Controllers

    class ColecaoController {
        - ColecaoService colecaoService
        - UsuarioRepository usuarioRepository
        + listarTodas(): ResponseEntity<List<ColecaoDTO>>
        + buscarPorId(int id): ResponseEntity<ColecaoDTO>
        + criar(ColecaoDTO dto, Principal principal): ResponseEntity<ColecaoDTO>
        + editar(int id, ColecaoDTO dto, Principal principal): ResponseEntity<ColecaoDTO>
        + deletar(int id, Principal principal): ResponseEntity<Void>
        - getAutor(Principal principal): Usuario
    }

    class EstampaController {
        - EstampaService estampaService
        - UsuarioRepository usuarioRepository
        + listarTodas(): ResponseEntity<List<EstampaDTO>>
        + buscarPorId(int id): ResponseEntity<EstampaDTO>
        + criar(EstampaDTO dto, Principal principal): ResponseEntity<EstampaDTO>
        + editar(int id, EstampaDTO dto, Principal principal): ResponseEntity<EstampaDTO>
        + deletar(int id, Principal principal): ResponseEntity<Void>
        - getAutor(Principal principal): Usuario
    }

    class PecaController {
        - PecaService pecaService
        - UsuarioRepository usuarioRepository
        + listarTodas(): ResponseEntity<List<PecaDTO>>
        + buscarPorId(int id): ResponseEntity<PecaDTO>
        + criar(PecaDTO dto, Principal principal): ResponseEntity<PecaDTO>
        + editar(int id, PecaDTO dto, Principal principal): ResponseEntity<PecaDTO>
        + deletar(int id, Principal principal): ResponseEntity<Void>
        - getAutor(Principal principal): Usuario
    }

    class ChaveiroController {
        - ChaveiroService chaveiroService
        - UsuarioRepository usuarioRepository
        + listarTodos(): ResponseEntity<List<ChaveiroDTO>>
        + buscarPorId(int id): ResponseEntity<ChaveiroDTO>
        + criar(ChaveiroDTO dto, Principal principal): ResponseEntity<ChaveiroDTO>
        + editar(int id, ChaveiroDTO dto, Principal principal): ResponseEntity<ChaveiroDTO>
        + deletar(int id, Principal principal): ResponseEntity<Void>
        - getAutor(Principal principal): Usuario
    }

    class AdesivoController {
        - AdesivoService adesivoService
        - UsuarioRepository usuarioRepository
        + listarTodos(): ResponseEntity<List<AdesivoDTO>>
        + buscarPorId(int id): ResponseEntity<AdesivoDTO>
        + criar(AdesivoDTO dto, Principal principal): ResponseEntity<AdesivoDTO>
        + editar(int id, AdesivoDTO dto, Principal principal): ResponseEntity<AdesivoDTO>
        + deletar(int id, Principal principal): ResponseEntity<Void>
        - getAutor(Principal principal): Usuario
    }

    class UsuarioController {
        - UsuarioService usuarioService
        - UsuarioRepository usuarioRepository
        - AuthenticationManager authenticationManager
        - JwtTokenProvider tokenProvider
        + listarTodos(): ResponseEntity<List<UsuarioDTO>>
        + buscarPorId(int id): ResponseEntity<UsuarioDTO>
        + criar(UsuarioDTO dto, Principal principal): ResponseEntity<UsuarioDTO>
        + editar(int id, UsuarioDTO dto, Principal principal): ResponseEntity<UsuarioDTO>
        + deletar(int id, Principal principal): ResponseEntity<Void>
        + login(LoginRequest loginRequest): ResponseEntity<LoginResponse>
        + criarAdminInicial(): ResponseEntity<UsuarioDTO>
        - getAutor(Principal principal): Usuario
    }

    class HistoricoAlteracaoController {
        - HistoricoAlteracaoService historicoService
        + getAll(): ResponseEntity<List<HistoricoAlteracaoDTO>>
        + getById(Long id): ResponseEntity<HistoricoAlteracaoDTO>
    }

%% Relações Completas (ATUALIZADO)

%% Fluxo principal do Adesivo (com auditoria)
    AdesivoController --> AdesivoService : chama
    AdesivoController --> UsuarioRepository : obtém autor
    AdesivoService --> AdesivoRepository : persiste/busca
    AdesivoService --> AdesivoMapper : converteDTO<->Model
    AdesivoService --> HistoricoAlteracaoService : registra logs
    AdesivoRepository --> Adesivo: trabalha com a entidade
    AdesivoMapper --> Adesivo
    AdesivoMapper --> AdesivoDTO

%% Fluxo principal da Coleção (com auditoria)
    ColecaoController --> ColecaoService : chama
    ColecaoController --> UsuarioRepository : obtém autor
    ColecaoService --> ColecaoRepository : persiste/busca
    ColecaoService --> ColecaoMapper : converteDTO<->Model
    ColecaoService --> HistoricoAlteracaoService : registra logs
    ColecaoRepository --> Colecao: trabalha com a entidade
    ColecaoMapper --> Colecao
    ColecaoMapper --> ColecaoDTO

%% Fluxo principal da Estampa (com auditoria + Coleção)
    EstampaController --> EstampaService : chama
    EstampaController --> UsuarioRepository : obtém autor
    EstampaService --> EstampaRepository : persiste/busca
    EstampaService --> EstampaMapper : converteDTO<->Model
    EstampaService --> ColecaoRepository : busca coleção
    EstampaService --> HistoricoAlteracaoService : registra logs
    EstampaRepository --> Estampa: trabalha com a entidade
    EstampaMapper --> Estampa
    EstampaMapper --> EstampaDTO

%% Fluxo principal da Peça (com auditoria)
    PecaController --> PecaService : chama
    PecaController --> UsuarioRepository : obtém autor
    PecaService --> PecaRepository : persiste/busca
    PecaService --> PecaMapper : converteDTO<->Model
    PecaService --> HistoricoAlteracaoService : registra logs
    PecaRepository --> Peca: trabalha com a entidade
    PecaMapper --> Peca
    PecaMapper --> PecaDTO

%% Fluxo principal do Chaveiro (com auditoria + Coleção)
    ChaveiroController --> ChaveiroService : chama
    ChaveiroController --> UsuarioRepository : obtém autor
    ChaveiroService --> ChaveiroRepository : persiste/busca
    ChaveiroService --> ChaveiroMapper : converteDTO<->Model
    ChaveiroService --> ColecaoRepository : busca coleção
    ChaveiroService --> HistoricoAlteracaoService : registra logs
    ChaveiroRepository --> Chaveiro: trabalha com a entidade
    ChaveiroMapper --> Chaveiro
    ChaveiroMapper --> ChaveiroDTO

%% Fluxo principal do Usuário (com segurança + auditoria)
    UsuarioController --> UsuarioService : chama
    UsuarioController --> UsuarioRepository : obtém autor
    UsuarioController --> AuthenticationManager : autentica
    UsuarioController --> JwtTokenProvider : gera token
    UsuarioService --> UsuarioRepository : persiste/busca
    UsuarioService --> UsuarioMapper : converteDTO<->Model
    UsuarioService --> HistoricoAlteracaoService : registra logs
    UsuarioService --> HistoricoAlteracaoRepository : verifica histórico
    UsuarioService --> PasswordEncoder : codifica senha
    UsuarioRepository --> Usuario: trabalha com a entidade
    UsuarioMapper --> Usuario
    UsuarioMapper --> UsuarioDTO

%% Fluxo principal do Histórico (READ-ONLY)
    HistoricoAlteracaoController --> HistoricoAlteracaoService : chama
    HistoricoAlteracaoService --> HistoricoAlteracaoRepository : persiste/busca
    HistoricoAlteracaoService --> HistoricoAlteracaoMapper : converteDTO<->Model
    HistoricoAlteracaoService --> UsuarioRepository : busca usuário
    HistoricoAlteracaoRepository --> HistoricoAlteracao: trabalha com a entidade
    HistoricoAlteracaoMapper --> HistoricoAlteracao
    HistoricoAlteracaoMapper --> HistoricoAlteracaoDTO

%% RELAÇÕES TRANSVERSAIS CRÍTICAS
    HistoricoAlteracaoService ..> Adesivo : audita
    HistoricoAlteracaoService ..> Colecao : audita
    HistoricoAlteracaoService ..> Estampa : audita
    HistoricoAlteracaoService ..> Peca : audita
    HistoricoAlteracaoService ..> Chaveiro : audita
    HistoricoAlteracaoService ..> Usuario : audita